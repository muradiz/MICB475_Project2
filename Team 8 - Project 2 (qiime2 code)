## Team 8 - Project 2 

#Importing data using a manifest file
qiime tools import \
--type "SampleData[SequencesWithQuality]" \
--input-format SingleEndFastqManifestPhred33V2 \
--input-path ./anemia_manifest.txt \
--output-path ./demux_seqs.qza

# Create visualization of demultiplexed samples
qiime demux summarize \
--i-data ./demux_seqs.qza \
--o-visualization ./demux_seqs.qzv

#Copy this from server to local computer to visualize demux_seqs.qzv
scp 

##Trimming to 250 bp 
# Determine ASVs with DADA2
qiime dada2 denoise-single \
--i-demultiplexed-seqs demux_seqs.qza \
--p-trim-left 0 \
--p-trunc-len 250 \
--o-representative-sequences /data/project_2/trimmed-to-250-data/rep-seqs_250.qza \
--o-table /data/project_2/trimmed-to-250-data/table_250.qza \
--o-denoising-stats /data/project_2/trimmed-to-250-data/stats_250.qza
  
#Move to trimmed-to-250-data directory
# Visualize DADA2 stats, working directory is /data/project_2/trimmed-to-250-data
qiime metadata tabulate \
--m-input-file stats_250.qza \
--o-visualization stats_250.qzv

# Visualize ASVs stats
qiime feature-table summarize \
--i-table table_250.qza \
--o-visualization table_250.qzv \
--m-sample-metadata-file /data/project_2/anemia_metadata.txt

qiime feature-table tabulate-seqs \
--i-data rep-seqs_250.qza \
--o-visualization rep-seqs_250.qzv

###Retraining the classifier
##First, make a directory for the retraining files, working directory is /data/project_2
mkdir training-feature-classifier
cd training-feature-classifier

##Downloading SILVA reference datasets, working directory is /data/project_2/training-feature-classifier 
wget \
-O "silva-138-99-seqs.qza" \
"https://data.qiime2.org/2020.8/common/silva-138-99-seqs.qza"

wget \
-O "silva-138-99-tax.qza" \
"https://data.qiime2.org/2020.8/common/silva-138-99-tax.qza"

wget \
-O "silva-138-99-seqs-515-806.qza" \
"https://data.qiime2.org/2020.8/common/silva-138-99-seqs-515-806.qza"

wget \
-O "silva-138-99-tax-515-806.qza" \
"https://data.qiime2.org/2020.8/common/silva-138-99-tax-515-806.qza"

#move to directory where I'd like to find the output ref-seq.qza file
cd ..

##Classifier training, working directory is /data/project_2
#replace the ref-otus.qza with the full length SILVA classifier sequence
#double-check primer sequences  
#replace trunc-len with value used in denoising step

qiime feature-classifier extract-reads \
--i-sequences /data/project_2/training-feature-classifiers/silva-138-99-seqs.qza \
--p-f-primer GTGCCAGCMGCCGCGGTAA \
--p-r-primer GGACTACHVGGGTWTCTAAT \
--p-trunc-len 250 \
--o-reads ref-seqs_250.qza \

qiime feature-classifier classify-sklearn \
--i-classifier /mnt/datasets/classifiers/silva-138-99-nb-classifier.qza \
--i-reads rep-seqs_250.qza \
--o-classification taxonomy_trimmed_250.qza

qiime metadata tabulate \
--m-input-file taxonomy_trimmed_250.qza \
--o-visualization taxonomy_trimmed_250.qzv
  
# Taxonomy barplots
qiime taxa barplot \
--i-table table_250.qza \
--i-taxonomy taxonomy_trimmed_250.qza \
--m-metadata-file /data/project_2/anemia_metadata.txt \
--o-visualization taxa-bar-plots_trimmed_250.qzv

# Taxonomy-based filtering
qiime taxa filter-table \
--i-table table_250.qza \
--i-taxonomy taxonomy_trimmed_250.qza \
--p-exclude mitochondria,chloroplast \
--o-filtered-table table-no-mitochondria-no-chloroplast.qza

#Convert .qza to .qzv file
qiime feature-table summarize \
--i-table table-no-mitochondria-no-chloroplast.qza \
--o-visualization table-no-mitochondria-no-chloroplast.qzv \
--m-sample-metadata-file /data/project_2/anemia_metadata.txt 

# Generate a tree for phylogenetic diversity analyses
qiime phylogeny align-to-tree-mafft-fasttree \
--i-sequences rep-seqs_250.qza \
--o-alignment aligned-rep-seqs.qza \
--o-masked-alignment masked-aligned-rep-seqs.qza \
--o-tree unrooted-tree.qza \
--o-rooted-tree rooted-tree.qza 

# Alpha-rarefaction 
#metadata category by age_months - if at least 10
#sampling depth 38021: fourteen 6-month olds, ten 1-year olds
#retain 912,504 (16.24%) features in 24 (12.44%) samples 

qiime diversity alpha-rarefaction \
--i-table table_250.qza \
--i-phylogeny rooted-tree.qza \
--p-max-depth 38021 \
--m-metadata-file /data/project_2/anemia_metadata.txt \
--o-visualization alpha-rarefaction_10samples.qzv

# Alpha-rarefaction
#age_months - if at least 15 in one age group
#sampling depth 35328: fifteen 6-month olds and twenty-two 1-year olds
#retain 1,307,136 (23.26%) features in 37 (19.17%) samples
qiime diversity alpha-rarefaction \
--i-table table_250.qza \
--i-phylogeny rooted-tree.qza \
--p-max-depth 35328 \
--m-metadata-file /data/project_2/anemia_metadata.txt \
--o-visualization alpha-rarefaction_15samples.qzv


